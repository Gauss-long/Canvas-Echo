# 前后端接口对齐检查报告

本文件梳理了 `vue-frontend/src/views/DesignReview.vue` 前端与后端接口（main.py、function.py）未对齐或容易出错的地方，供开发自查。

---

## 1. 会话创建接口 `/db/create_session`

- **后端返回：**
  ```json
  {
    "success": true,
    "session_id": ...,
    "user_id": ...,
    "title": ...,
    "created_at": ...,
    "messages": []
  }
  ```
- **前端 `createSession` 处理：**
  - 能正确解析 `id`、`user_id`、`title`、`created_at`、`messages`，并转为 `Session` 类型，**这一块是对齐的**。

---

## 2. 会话删除接口 `/db/delete_session`

- **后端：**
  - `@app.delete("/db/delete_session")`，参数为 `{"session_id": int}`，返回 `{"success": true}`。
- **前端：**
  - `deleteSession` 方法用 `fetch('/db/delete_session', { method: 'DELETE', ... })`，参数和用法对齐。
  - **注意**：前端删除本地 session 后再调接口，若接口失败，本地已删，可能导致前后端不一致。

---

## 3. 历史会话拉取 `/db/history`

- **后端返回：**
  - `{"success": true, "sessions": [ { id, user_id, title, created_at, messages: [...] } ] }`
- **前端：**
  - `loadHistoryFromDatabase` 能正确解析所有字段，**对齐**。

---

## 4. 消息创建接口 `/db/create_message` `/db/create_message_pair`

- **后端：**
  - `@app.post("/db/create_message")`，参数为 `session_id, content, role, image`
  - `@app.post("/db/create_message_pair")`，参数为两组消息
- **前端：**
  - 目前 `sendMessage` 只调用 `/db/add_message_pair`（如果有），但你代码片段未展示完整消息写入逻辑，需确认是否用的是 `/db/create_message` 或 `/db/create_message_pair`，参数是否齐全。

---

## 5. 消息结构

- **后端 Message 字段：**
  - `id, session_id, content, image, role, timestamp`
- **前端 addMessage/addMessage 传参：**
  - 你有时只传 `role, content, image`，**缺少 id, session_id, timestamp**，导致类型报错。
  - 前端新建消息时，`id` 应为 0 或临时值，`session_id` 用当前会话 id，`timestamp` 用 `new Date()`。

---

## 6. 类型不一致/类型不安全

- **Session/Message 类型定义与后端一致，但前端 addMessage/addMessage 时常常只传部分字段，导致类型不对齐。**
- **前端有时用 `string | number` 作为 id，后端只认 int。**

---

## 7. 其它细节

- **删除会话时，前端先删本地再调接口，若接口失败，前端已丢失数据。**
- **loadSession、startNewChat 等方法对 currentSession 的赋值，需保证所有字段齐全。**
- **rateResponse 直接给 message 加 rating 字段，后端没有此字段。**

---

## 总结：主要未对齐/易错点

1. **addMessage/addMessage 传参字段不全**（缺 id、session_id、timestamp）
2. **Session/Message id 类型混用 string/number，后端只认 int**
3. **删除会话时前后端同步问题**
4. **rateResponse/rating 字段前后端不一致**
5. **部分接口调用（如消息写入）未完全展示，需确认参数和接口是否一致** 